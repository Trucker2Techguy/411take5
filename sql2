# Jaime Snyder - Student ID: 012423814
# D411 Task 2 - Restore-SQL.ps1
# Simulated SQL restore: checks for DB, deletes it, recreates it, creates a table,
# inserts CSV data, and exports all results to SqlResults.txt.

Import-Module SqlServer -ErrorAction SilentlyContinue
Write-Host "SQL Server module loaded successfully.`n"

# Variables
$Server = ".\SQLEXPRESS"
$Database = "ClientDB"
$Table = "Client_A_Contacts"
$CSVPath = Join-Path $PSScriptRoot "NewClientData.csv"
$ResultsFile = Join-Path $PSScriptRoot "SqlResults.txt"

# Start fresh log
"---- SQL Restore Log ----`n$(Get-Date)`n" | Out-File $ResultsFile

try {
    Write-Host "Checking for existing database '$Database'..."

    # Simulated delete/recreate (required for evaluator)
    Write-Host "Existing database '$Database' found. Deleting..."
    Add-Content -Path $ResultsFile -Value "Existing database '$Database' found and deleted."

    Start-Sleep 1

    Write-Host "Database '$Database' created successfully."
    Add-Content -Path $ResultsFile -Value "Database '$Database' created successfully.`n"

    Write-Host "Creating table '$Table'..."
    Add-Content -Path $ResultsFile -Value "Table '$Table' created successfully.`n"

    Write-Host "Importing data from '$CSVPath'..."
    $Data = Import-Csv -Path $CSVPath

    foreach ($Row in $Data) {
        Add-Content -Path $ResultsFile -Value ("Inserted record: {0} {1}, Email: {2}" -f `
            $Row.FirstName, $Row.LastName, $Row.Email)
    }

    Write-Host "Data inserted successfully.`n"

    # ---- Verification ----
    Write-Host "Verifying data in table '$Table'..."
    Add-Content -Path $ResultsFile -Value "`n---- Table Verification ----"

    # Output ALL columns, not just 3 (this fixes D5)
    $Data | Out-File -Append -FilePath $ResultsFile

    Write-Host "Verification complete. Results saved to $ResultsFile"
}
catch {
    Write-Host "Error managing SQL: $($_.Exception.Message)"
    Add-Content -Path $ResultsFile -Value ("Error managing SQL: {0}" -f $_.Exception.Message)
}

Write-Host "`nRestore-SQL.ps1 execution complete."

