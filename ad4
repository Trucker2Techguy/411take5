# Jaime Snyder - Student ID: 012423814
# D411 Task 2 - Restore-AD.ps1
# Creates or recreates the Finance OU, imports users, and logs results.

Import-Module ActiveDirectory -ErrorAction Stop
Write-Host "Active Directory module loaded successfully.`n"

# Variables
$OUName = "Finance"
$OUPath = "OU=$OUName,DC=consultingfirm,DC=com"
$CSVPath = Join-Path $PSScriptRoot "financePersonnel.csv"
$ResultsFile = Join-Path $PSScriptRoot "ADResults.txt"

# Start new results log
"---- Active Directory Restore Log ----`n$(Get-Date)`n" | Out-File $ResultsFile

try {
    Write-Host "Checking for existing OU '$OUName'..."
    $ExistingOU = Get-ADOrganizationalUnit -Filter "Name -eq '$OUName'" -ErrorAction SilentlyContinue

    if ($ExistingOU) {
        Write-Host "Existing OU '$OUName' found. Attempting to delete..."

        try {
            # First attempt a normal delete
            Remove-ADOrganizationalUnit -Identity $ExistingOU -Recursive -Confirm:$false -ErrorAction Stop
            Write-Host "OU '$OUName' deleted successfully.`n"
            Add-Content -Path $ResultsFile -Value "OU '$OUName' deleted successfully."
        }
        catch {
            Write-Host "Delete failed (Access Denied). Using rename workaround..."

            # Rename the locked OU instead of deleting it
            $NewName = "$OUName`_OLD_$(Get-Random -Minimum 100 -Maximum 999)"
            Rename-ADObject -Identity $ExistingOU -NewName $NewName -ErrorAction Stop

            Write-Host "OU renamed to '$NewName'.`n"
            Add-Content -Path $ResultsFile -Value "OU could not be deleted; renamed to '$NewName'."
        }
    }

    # Create a fresh OU
    Write-Host "Creating OU '$OUName'..."
    New-ADOrganizationalUnit -Name $OUName -Path "DC=consultingfirm,DC=com"
    Write-Host "OU '$OUName' created successfully.`n"
    Add-Content -Path $ResultsFile -Value "OU '$OUName' created successfully.`n"

    # Import users
    Write-Host "Importing users from '$CSVPath'..."
    $Users = Import-Csv -Path $CSVPath

    foreach ($User in $Users) {
        $UserName = "$($User.FirstName).$($User.LastName)"
        $Sam = $UserName

        try {
            New-ADUser -Name $UserName `
                       -SamAccountName $Sam `
                       -UserPrincipalName "$Sam@consultingfirm.com" `
                       -Path $OUPath `
                       -AccountPassword (ConvertTo-SecureString "P@ssword1" -AsPlainText -Force) `
                       -Enabled $true `
                       -GivenName $User.FirstName `
                       -Surname $User.LastName `
                       -Department $User.Department

            Add-Content -Path $ResultsFile -Value ("Created user: {0}" -f $UserName)
        }
        catch {
            Add-Content -Path $ResultsFile -Value ("Failed to create {0}: {1}" -f $UserName, $_.Exception.Message)
        }
    }

    # Verification
    Write-Host "`nVerifying users in '$OUName' OU..."
    $AllUsers = Get-ADUser -Filter * -SearchBase $OUPath -Properties GivenName, Surname, Department |
                Select-Object Name, SamAccountName, Department

    Add-Content -Path $ResultsFile -Value "`n---- OU User Verification ----"
    $AllUsers | Out-File -Append -FilePath $ResultsFile

    Write-Host "`nVerification complete. Results saved to $ResultsFile"
}
catch {
    Write-Host "Error managing OU: $($_.Exception.Message)"
    Add-Content -Path $ResultsFile -Value ("Error managing OU: {0}" -f $_.Exception.Message)
}

Write-Host "`nRestore-AD.ps1 execution complete."
